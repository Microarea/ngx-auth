!function(n,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("@angular/core"),require("@angular/common/http"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@angular/common"),require("@angular/forms"),require("@progress/kendo-angular-inputs"),require("@progress/kendo-angular-buttons")):"function"==typeof define&&define.amd?define("@tb/auth",["exports","@angular/core","@angular/common/http","@angular/router","rxjs","rxjs/operators","@angular/common","@angular/forms","@progress/kendo-angular-inputs","@progress/kendo-angular-buttons"],o):o(((n=n||self).tb=n.tb||{},n.tb.auth={}),n.ng.core,n.ng.common.http,n.ng.router,n.rxjs,n.rxjs.operators,n.ng.common,n.ng.forms,n.kendoAngularInputs,n.kendoAngularButtons)}(this,function(n,o,e,t,i,r,a,l,s,c){"use strict";function g(n,o,e,t){var i,r=arguments.length,a=r<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,e):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(n,o,e,t);else for(var l=n.length-1;l>=0;l--)(i=n[l])&&(a=(r<3?i(a):r>3?i(o,e,a):i(o,e))||a);return r>3&&a&&Object.defineProperty(o,e,a),a}function u(n,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(n,o)}function p(n,o,e,t){return new(e||(e=Promise))(function(i,r){function a(n){try{s(t.next(n))}catch(o){r(o)}}function l(n){try{s(t["throw"](n))}catch(o){r(o)}}function s(n){n.done?i(n.value):new e(function(o){o(n.value)}).then(a,l)}s((t=t.apply(n,o||[])).next())})}function d(n,o){var e,t,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:l(0),"throw":l(1),"return":l(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function l(r){return function(l){return function(r){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,t&&(i=2&r[0]?t["return"]:r[0]?t["throw"]||((i=t["return"])&&i.call(t),0):t.next)&&!(i=i.call(t,r[1])).done)return i;switch(t=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,t=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=o.call(n,a)}catch(l){r=[6,l],t=0}finally{e=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,l])}}}var f=function(){function n(){}return n.JWT="M4_jwt_token",n.CULTURE="M4_culture",n.UI_CULTURE="M4_ui_culture",n.ACCOUNT_NAME="M4_account_name",n}(),h=function(){function n(n,o,e){this.env=n,this.http=o,this.router=e,this.redirectUrl="/"}var a,l;return n.prototype.isValidToken=function(n){return void 0===n&&(n=null),p(this,void 0,void 0,function(){var o,e=this;return d(this,function(t){return o=sessionStorage.getItem(f.JWT),console.log("isValidToken - authtoken",o),o||n?[2,this.http.post(this.getIsValidTokenUrl(),n||{}).pipe(r.tap(function(n){console.log("isValidToken - response",n),n.Result||(n.Message=n.Message?n.Message:"Login error...",e.errorMessage=n.Message)})).toPromise()]:[2,i.of(!1)]})})},n.prototype.login=function(n){var o=this;return this.http.post(this.getLoginUrl(),n).pipe(r.map(function(n){var e=n.Culture===undefined||0===n.Culture.length?window.navigator.language:n.Culture,t=n.UICulture===undefined||0===n.UICulture.length?window.navigator.language:n.UICulture;return o.saveCulture(e,t),n.Result?(sessionStorage.setItem(f.JWT,n.JwtToken),n):(n.Message=n.Message?n.Message:"Login error...",sessionStorage.removeItem(f.JWT),o.errorMessage=n.Message,n)}))},n.prototype.getIsValidTokenUrl=function(){return this.getBaseUrl()+"token/"},n.prototype.getLoginUrl=function(){return this.getBaseUrl()+"tokens/"},n.prototype.getLogoutUrl=function(){return this.getBaseUrl()+"logout/"},n.prototype.getRedirectUrl=function(){return this.redirectUrl},n.prototype.setRedirectUrl=function(n){this.redirectUrl=n},n.prototype.getBaseUrl=function(){return this.loginUrl?this.loginUrl:(this.loginUrl=this.env.auth.url,this.loginUrl)},n.prototype.logoff=function(){},n.prototype.saveCulture=function(n,o){void 0===n&&(n=""),void 0===o&&(o=""),localStorage.setItem(f.CULTURE,n),localStorage.setItem(f.UI_CULTURE,o)},n.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new n(o.ɵɵinject("env"),o.ɵɵinject(e.HttpClient),o.ɵɵinject(t.Router))},token:n,providedIn:"root"}),n=g([o.Injectable({providedIn:"root"}),(a=0,l=o.Inject("env"),function(n,o){l(n,o,a)}),u("design:paramtypes",[Object,e.HttpClient,t.Router])],n)}(),b=function(){function n(n,o){this.authService=n,this.router=o}return n.prototype.canActivate=function(n,o){return p(this,void 0,void 0,function(){var e,t,i,r;return d(this,function(a){switch(a.label){case 0:return console.log("ActivatedRouteSnapshot",n,o.url),t=n.queryParams.hasOwnProperty("jwt")?n.queryParams.jwt:null,i=n.queryParams.hasOwnProperty("subKey")?n.queryParams.subKey:null,t&&i&&(e={JwtToken:t,SubscriptionKey:i}),sessionStorage.getItem(f.JWT)||e?[4,this.authService.isValidToken(e)]:[3,2];case 1:return r=a.sent(),console.log("isValidToken",r),r.Success?[2,!0]:(this.router.navigate(["login"]),[2,!1]);case 2:return this.router.navigate(["login"]),[2,!0];case 3:return[2]}})})},n.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new n(o.ɵɵinject(h),o.ɵɵinject(t.Router))},token:n,providedIn:"root"}),n=g([o.Injectable({providedIn:"root"}),u("design:paramtypes",[h,t.Router])],n)}(),m=function(){function n(){}return n.prototype.intercept=function(n,o){var e=JSON.stringify({token:sessionStorage.getItem(f.JWT)});return e&&(n=n.clone({setHeaders:{Authorization:e}})),o.handle(n).pipe()},n=g([o.Injectable(),u("design:paramtypes",[])],n)}(),x=function(){return function(){this.accountName="",this.password=""}}(),v=function(){function n(n,o){this.authService=n,this.router=o,this.capsLockOn=!1,this.loading=!1,this.loginRequest=new x}return n.prototype.ngOnInit=function(){this.loadAccountName()},n.prototype.keyUpFunction=function(n){13===n.keyCode&&this.loginRequest.accountName&&this.login();var o=n.getModifierState&&n.getModifierState("CapsLock");this.capsLockOn=o},n.prototype.disabledButton=function(){return!this.loginRequest.accountName||this.loading},n.prototype.accountNameBlur=function(){},n.prototype.login=function(){return p(this,void 0,void 0,function(){var n,o,e=this;return d(this,function(t){switch(t.label){case 0:return this.authService.errorMessage="",this.saveAccountName(),this.loading=!0,[4,this.authService.login(this.loginRequest).toPromise()["catch"](function(n){e.loading=!1,console.error("Login Error",n),e.authService.errorMessage=n.error&&n.error.Message})];case 1:return(n=t.sent())?(n.Result?(o=this.authService.getRedirectUrl(),console.log("Redirect Url",o),this.authService.errorMessage="",this.router.navigate([o])):(console.error("authService.errorMessage:",this.authService.errorMessage),this.loading=!1),[2]):[2]}})})},n.prototype.loadAccountName=function(){this.loginRequest.accountName=localStorage.getItem(f.ACCOUNT_NAME)},n.prototype.saveAccountName=function(){localStorage.setItem(f.ACCOUNT_NAME,this.loginRequest.accountName)},n=g([o.Component({selector:"tb-login",template:'<div class="login-container">\n    <div class="container">\n        <div class=" login">\n            <div class="login-header">\n                <img class="d-lg-none" src="assets/images/logoM4_w160.png" />\n                <h3>Sign in</h3>\n            </div>\n\n            <div class="login-form">\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Account Name">\n                        <input\n                            kendoTextBox\n                            autofocus\n                            [(ngModel)]="loginRequest.accountName"\n                            (blur)="accountNameBlur()"\n                            (keyup)="keyUpFunction($event)"\n                            name="accountName"\n                            autocomplete="off"\n                        />\n                    </kendo-textbox-container>\n                </div>\n\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Password">\n                        <input\n                            kendoTextBox\n                            [(ngModel)]="loginRequest.password"\n                            (keyup)="keyUpFunction($event)"\n                            name="password"\n                            type="password"\n                            autocomplete="new-password"\n                        />\n                    </kendo-textbox-container>\n                </div>\n            </div>\n\n            <div class="caps-lock" *ngIf="capsLockOn"><span class="k-icon k-i-warning"></span> Caps lock on</div>\n            <div class="login-error" *ngIf="authService.errorMessage">\n                <span class="k-icon k-i-warning"></span>{{ authService.errorMessage }}\n            </div>\n\n            <div class="login-footer">\n                <div class="login-button-container">\n                    <button kendoButton class="login-button" (click)="login()" [disabled]="disabledButton()">\n                        <span class="k-icon k-i-loading" *ngIf="loading"></span>\n                        <span *ngIf="!loading">Login</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n        <div class="intro d-none d-lg-flex">\n            <img src="assets/images/logoM4_w160.png" />\n\n            <div class="welcome">\n                <h2>Welcome to <strong>M4Cloud</strong></h2>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n            </div>\n\n            <p class="d-md-block">&nbsp;</p>\n        </div>\n    </div>\n</div>\n<p class="copyright copyright-abs">© 2017 - 2019 Zucchetti s.p.a.</p>\n',styles:[':host(tb-login){font-family:"Fira Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"!important;background:#013b5e;display:block;min-height:100vh;padding:0;margin:0;overflow:auto;height:100%}:host(tb-login) .login-container{display:flex;min-height:100%;justify-content:center;align-items:center}@media screen and (min-height:376px){:host(tb-login) .login-container{min-height:90%;margin:30px 0}}:host(tb-login) .login-container .container{display:flex;flex-direction:row-reverse;flex-wrap:nowrap;min-height:50vh}@media screen and (min-width:576px){:host(tb-login) .login-container .container{min-height:70vh}}@media screen and (min-width:1025px){:host(tb-login) .login-container .container{min-height:80vh}}:host(tb-login) .login-container .container .intro{background:#00578c;padding:30px 50px;display:flex;flex-direction:column;flex-wrap:nowrap;flex:1;justify-content:space-between}:host(tb-login) .login-container .container .intro img{align-self:flex-start}:host(tb-login) .login-container .container .intro .welcome h2{font-size:30px;font-weight:300;color:#fff;margin:-50px 0 30px}:host(tb-login) .login-container .container .intro .welcome h2 strong{font-weight:400;font-size:40px}:host(tb-login) .login-container .container .intro .welcome p{color:#fff;font-size:14px;font-weight:300;line-height:1.4em}:host(tb-login) .login-container .container .login{flex:1;display:flex;padding:10px 20px;flex-direction:column;justify-content:space-between;background:#0277bd}@media screen and (min-width:992px){:host(tb-login) .login-container .container .login{flex:40% 0}}:host(tb-login) .login-container .container .login .login-header{display:flex;flex-direction:row;justify-content:space-between;align-items:center}:host(tb-login) .login-container .container .login .login-header img{width:150px}:host(tb-login) .login-container .container .login .login-header h3{color:#fff;font-size:30px;margin:0;font-weight:300}:host(tb-login) .login-container .container .login .login-form{display:flex;flex-direction:column;flex:1;justify-content:center;margin:10px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container{width:100%;margin:3px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container>.k-label{font-weight:300;color:#8ee2ff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-input.k-textbox,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textarea,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textbox{border:none;border-bottom:1px solid #8ee2ff;border-radius:0;color:#fff;background:#0277bd;box-shadow:none;padding:10px 0;height:36px;caret-color:#fff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container::after{background-color:#8ee2ff;height:1px}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown{border:none;background:0 0;border-bottom:1px solid #8ee2ff!important}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap{border:none;border-radius:0;padding:0;box-shadow:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap>.k-input{background:#0277bd!important;height:36px;opacity:1;color:#fff;padding:0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled{opacity:1;color:#fff;-webkit-filter:none;filter:none;border-bottom:1px dashed #8ee2ff;background:#0277bd}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled .k-select{display:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select{color:#8ee2ff;opacity:1;background:#0277bd;border-radius:0;border:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select .k-icon{color:#8ee2ff}:host(tb-login) .login-container .container .login .caps-lock{margin:0 0 10px;background:#00578c;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em;display:flex;align-items:center}:host(tb-login) .login-container .container .login .caps-lock span{margin-right:5px}:host(tb-login) .login-container .container .login .login-error{margin:0 0 10px;background:#ff6358;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em}:host(tb-login) .login-container .container .login .login-error span{margin-right:5px}:host(tb-login) .login-container .container .login .login-footer{display:flex;flex-direction:row;justify-content:flex-end;align-items:center}:host(tb-login) .login-container .container .login .login-footer .login-button{padding:10px 70px;background:#3daf68;color:#fff}:host(tb-login) .login-container .container .login .login-footer .login-button.k-state-disabled{background-color:rgba(0,87,140,.5);border-color:#00598e;color:#54aee4;cursor:not-allowed}:host(tb-login) .login-container .container .login .login-footer .login-button .k-i-loading{font-size:20px}:host(tb-login) .login-container .container .login .login-footer .server-info{display:flex;flex-direction:row;align-items:center;margin-right:10px}:host(tb-login) .login-container .container .login .login-footer .server-info #server-info-label{font-size:11px;font-weight:300;color:#fff;margin:0 10px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon{color:#fff;font-size:20px;padding-top:3px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon .k-icon{margin-top:-8px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon m4-icon{cursor:pointer}:host(tb-login) .login-container .container .login .login-footer .server-info.server-down #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-down .icon{color:#ffc000}:host(tb-login) .login-container .container .login .login-footer .server-info.server-up #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-up .icon{color:#3daf68}:host(tb-login) p.copyright{font-size:10px;font-weight:300;margin:0;color:#fff}:host(tb-login) p.copyright-abs{position:absolute;bottom:5px;color:#ccc;text-align:center;width:100%}:host(tb-login) .server-info-popup{padding:5px 7px;min-width:150px;background:#013b5e}:host(tb-login) .server-info-popup h3{font-size:20px;color:#fff;font-weight:300;margin:0 0 10px;text-align:center}:host(tb-login) .server-info-popup a.tb-btn{padding:7px 7px 5px;text-align:center;background:#0277bd;color:#fff;margin:10px 0;display:block;border-radius:4px;border:1px solid #00578c}:host(tb-login) .server-info-popup .dl-horizontal{margin:0;padding:0 20px 0 0;color:#fff}:host(tb-login) .server-info-popup .dl-horizontal dt{float:left;width:80px;overflow:hidden;clear:left;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-size:12px;font-weight:500}:host(tb-login) .server-info-popup .dl-horizontal dd{margin-left:90px;font-size:12px;font-weight:300}:host(tb-login) input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px #0277bd inset!important;-webkit-text-fill-color:#fff!important}:host(tb-login) :focus{outline:0}@media (min-width:576px){:host(tb-login) .container .login{padding:20px}:host(tb-login) .container .login .login-form ::ng-deep .k-textbox-container{margin:10px 0}}@media (min-width:992px){:host(tb-login) .container .login .login-header{justify-content:flex-end}}']}),u("design:paramtypes",[h,t.Router])],n)}(),k=function(){function n(n,o){this.authService=n,this.router=o}return n=g([o.Component({selector:"tb-logout",template:""}),u("design:paramtypes",[h,t.Router])],n)}(),w=function(){function n(){}var e;return e=n,n.forRoot=function(){return{ngModule:e,providers:[h]}},n=e=g([o.NgModule({declarations:[v,k],imports:[a.CommonModule,l.FormsModule,s.InputsModule,c.ButtonsModule],exports:[v,k]})],n)}();n.TbAuthGuard=b,n.TbAuthInterceptor=m,n.TbAuthModule=w,n.TbAuthService=h,n.TbLoginComponent=v,n.TbLogoutComponent=k,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=tb-auth.umd.min.js.map