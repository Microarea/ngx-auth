!function(n,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("moment"),require("@angular/router"),require("@angular/core"),require("@angular/common"),require("@angular/forms"),require("@progress/kendo-angular-inputs"),require("@progress/kendo-angular-buttons")):"function"==typeof define&&define.amd?define("@tb/auth",["exports","@angular/common/http","rxjs","rxjs/operators","moment","@angular/router","@angular/core","@angular/common","@angular/forms","@progress/kendo-angular-inputs","@progress/kendo-angular-buttons"],o):o((n.tb=n.tb||{},n.tb.auth={}),n.ng.common.http,n.rxjs,n.rxjs.operators,n.moment_,n.ng.router,n.ng.core,n.ng.common,n.ng.forms,n.kendoAngularInputs,n.kendoAngularButtons)}(this,function(n,o,t,i,e,r,a,l,s,c,g){"use strict";function p(){}function u(){this.Result=!1}var d=function L(){this.AccountName="",this.Password="",this.AppId="M4",this.JwtToken="",this.SubscriptionKey=null},f=(h.JWT="M4_jwt_token",h.EXP="M4_jwt_token_expiration_date",h.CULTURE="M4_culture",h.UI_CULTURE="M4_ui_culture",h.ACCOUNT_NAME="M4_account_name",h);function h(){}function b(){}function m(){this.JwtToken=""}function x(o,a,l,s){return new(l||(l=Promise))(function(n,e){function t(n){try{r(s.next(n))}catch(o){e(o)}}function i(n){try{r(s["throw"](n))}catch(o){e(o)}}function r(o){o.done?n(o.value):new l(function(n){n(o.value)}).then(t,i)}r((s=s.apply(o,a||[])).next())})}function v(t,i){var r,a,l,n,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return n={next:o(0),"throw":o(1),"return":o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(n){return function e(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,a&&(l=2&n[0]?a["return"]:n[0]?a["throw"]||((l=a["return"])&&l.call(a),0):a.next)&&!(l=l.call(a,n[1])).done)return l;switch(a=0,l&&(n=[2&n[0],l.value]),n[0]){case 0:case 1:l=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,a=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!l||n[1]>l[0]&&n[1]<l[3])){s.label=n[1];break}if(6===n[0]&&s.label<l[1]){s.label=l[1],l=n;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(n);break}l[2]&&s.ops.pop(),s.trys.pop();continue}n=i.call(t,s)}catch(o){n=[6,o],a=0}finally{r=l=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([o,n])}}}var k=e,y=(w.prototype.login=function(n){var o=this;return this.http.post(this.getLoginUrl(),n).pipe(i.map(function(n){return n.Result?o.storageData(n):(o.clearStorage(),n.Message=n.Message?n.Message:"Login error...",o.errorMessage=n.Message),n})).toPromise()},w.prototype.isValidToken=function(e){return void 0===e&&(e=null),x(this,void 0,void 0,function(){var o=this;return v(this,function(n){return e?[2,this.http.get(this.getIsValidTokenUrl()+e).pipe(i.tap(function(n){console.log("isValidToken - response",n),n.Result||(n.Message=n.Message?n.Message:"isValidToken error...",o.errorMessage=n.Message)})).toPromise()]:[2,t.of(!1)]})})},w.prototype.getRedirectUrl=function(){return this.redirectUrl},w.prototype.setRedirectUrl=function(n){this.redirectUrl=n},w.prototype.getBaseUrl=function(){return this.loginUrl||(this.loginUrl=this.env.auth.url),this.loginUrl},w.prototype.getIsValidTokenUrl=function(){return this.getBaseUrl()+"isvalidtoken/"},w.prototype.getLoginUrl=function(){return this.getBaseUrl()+"login/"},w.prototype.getLogoutUrl=function(){return this.getBaseUrl()+"logout/"},w.prototype.getChangePasswordUrl=function(){return this.getBaseUrl()+"changepassword/"},w.prototype.getResetPasswordUrl=function(){return this.getBaseUrl()+"resetpassword/"},w.prototype.getSubsKeysForAccountUrl=function(){return this.getBaseUrl()+"subscriptionskeysforaccount/"},w.prototype.logoff=function(){},w.prototype.saveCulture=function(n,o){void 0===n&&(n=""),void 0===o&&(o=""),localStorage.setItem(f.CULTURE,n),localStorage.setItem(f.UI_CULTURE,o)},w.prototype.clearStorage=function(){localStorage.removeItem(f.JWT),localStorage.removeItem(f.EXP),localStorage.removeItem(f.CULTURE),localStorage.removeItem(f.UI_CULTURE)},w.prototype.isExpired=function(){var n=localStorage.getItem(f.EXP);if(!n)return!1;var o=JSON.parse(n);return k().isAfter(k(o))},w.prototype.storageData=function(n){var o=n.RegionalSettings===undefined||0===n.RegionalSettings.length?window.navigator.language:n.RegionalSettings,e=n.Language===undefined||0===n.Language.length?window.navigator.language:n.Language;this.saveCulture(o,e),localStorage.setItem(f.JWT,n.JwtToken);var t=n.ExpirationDate?k(n.ExpirationDate):k().add(1,"day");localStorage.setItem(f.EXP,JSON.stringify(t.valueOf()))},w.decorators=[{type:a.Injectable,args:[{providedIn:"root"}]}],w.ctorParameters=function(){return[{type:undefined,decorators:[{type:a.Inject,args:["env"]}]},{type:o.HttpClient},{type:r.Router}]},w.ngInjectableDef=a.defineInjectable({factory:function(){return new w(a.inject("env"),a.inject(o.HttpClient),a.inject(r.Router))},token:w,providedIn:"root"}),w);function w(n,o,e){this.env=n,this.http=o,this.router=e,this.redirectUrl="/"}var S=(U.prototype.canActivate=function(s,c){return x(this,void 0,void 0,function(){var o,e,t,i,r,a,l=this;return v(this,function(n){switch(n.label){case 0:return console.log("ActivatedRouteSnapshot",s,c.url),o=s.queryParams.hasOwnProperty("jwt")?s.queryParams.jwt:null,e=s.queryParams.hasOwnProperty("subKey")?s.queryParams.subKey:null,o&&e?((t=new d).JwtToken=o,t.SubscriptionKey=e,t.AppId=this.env.auth.appid,[4,this.authService.login(t)["catch"](function(n){l.authService.errorMessage=n.error&&n.error.Message,l.router.navigate(["login"])})]):[3,2];case 1:if(!(i=n.sent()))return this.router.navigate(["login"]),[2,!1];i.Result&&(r=this.authService.getRedirectUrl(),this.authService.errorMessage="",this.router.navigate([r])),n.label=2;case 2:return this.authService.isExpired()?(this.authService.errorMessage="Token expired",this.authService.clearStorage(),this.router.navigate(["login"]),[2,!0]):(a=localStorage.getItem(f.JWT))?[4,this.authService.isValidToken(a)]:[3,4];case 3:return n.sent().Result?[2,!0]:(this.router.navigate(["login"]),[2,!1]);case 4:return this.router.navigate(["login"]),[2,!0];case 5:return[2]}})})},U.decorators=[{type:a.Injectable,args:[{providedIn:"root"}]}],U.ctorParameters=function(){return[{type:y},{type:r.Router},{type:undefined,decorators:[{type:a.Inject,args:["env"]}]}]},U.ngInjectableDef=a.defineInjectable({factory:function(){return new U(a.inject(y),a.inject(r.Router),a.inject("env"))},token:U,providedIn:"root"}),U);function U(n,o,e){this.authService=n,this.router=o,this.env=e}var I=(M.prototype.intercept=function(n,o){var e=JSON.stringify({token:localStorage.getItem(f.JWT)});return e&&(n=n.clone({setHeaders:{Authorization:e}})),o.handle(n).pipe()},M.decorators=[{type:a.Injectable}],M.ctorParameters=function(){return[]},M);function M(){}var R=(j.prototype.ngOnInit=function(){this.loadAccountName()},j.prototype.keyUpFunction=function(n){13===n.keyCode&&this.loginRequest.AccountName&&this.login();var o=n.getModifierState&&n.getModifierState("CapsLock");this.capsLockOn=o},j.prototype.disabledButton=function(){return!this.loginRequest.AccountName||this.loading},j.prototype.accountNameBlur=function(){},j.prototype.login=function(){return x(this,void 0,void 0,function(){var o,e,t=this;return v(this,function(n){switch(n.label){case 0:return this.authService.errorMessage="",this.saveAccountName(),this.loading=!0,[4,this.authService.login(this.loginRequest)["catch"](function(n){t.loading=!1,t.authService.errorMessage=n.error&&n.error.Message})];case 1:return o=n.sent(),this.loading=!1,o&&(o.Result?(e=this.authService.getRedirectUrl(),this.authService.errorMessage="",this.router.navigate([e])):this.loading=!1),[2]}})})},j.prototype.loadAccountName=function(){this.loginRequest.AccountName=localStorage.getItem(f.ACCOUNT_NAME)},j.prototype.saveAccountName=function(){localStorage.setItem(f.ACCOUNT_NAME,this.loginRequest.AccountName)},j.decorators=[{type:a.Component,args:[{selector:"tb-login",template:'<div class="login-container">\n    <div class="container">\n        <div class=" login">\n            <div class="login-header">\n                <img class="d-lg-none" src="assets/images/logoM4_w160.png" />\n                <h3>Sign in</h3>\n            </div>\n\n            <div class="login-form">\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Account Name">\n                        <input\n                            kendoTextBox\n                            autofocus\n                            [(ngModel)]="loginRequest.AccountName"\n                            (blur)="accountNameBlur()"\n                            (keyup)="keyUpFunction($event)"\n                            name="accountName"\n                            autocomplete="off"\n                        />\n                    </kendo-textbox-container>\n                </div>\n\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Password">\n                        <input\n                            kendoTextBox\n                            [(ngModel)]="loginRequest.Password"\n                            (keyup)="keyUpFunction($event)"\n                            name="password"\n                            type="password"\n                            autocomplete="new-password"\n                        />\n                    </kendo-textbox-container>\n                </div>\n                <div class="login-infos">\n                    <div class="caps-lock" *ngIf="capsLockOn"><span class="k-icon k-i-warning"></span> Caps lock on</div>\n                    <div class="login-error" *ngIf="authService.errorMessage">\n                        <span class="k-icon k-i-warning"></span>{{ authService.errorMessage }}\n                    </div>\n                </div>\n            </div>\n\n            <div class="login-footer">\n                <div class="login-button-container">\n                    <button kendoButton class="login-button" (click)="login()" [disabled]="disabledButton()">\n                        <span class="k-icon k-i-loading" *ngIf="loading"></span>\n                        <span *ngIf="!loading">Login</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n        <div class="intro d-none d-lg-flex">\n            <img src="assets/images/logoM4_w160.png" />\n\n            <div class="welcome">\n                <h2>Welcome to <strong>M4Cloud</strong></h2>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n            </div>\n\n            <p class="d-md-block">&nbsp;</p>\n        </div>\n    </div>\n</div>\n<p class="copyright copyright-abs">© 2017 - 2019 Zucchetti s.p.a.</p>\n',styles:[':host(tb-login){font-family:"Fira Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"!important;background:#013b5e;display:block;min-height:100vh;padding:0;margin:0;overflow:auto;height:100%}:host(tb-login) .login-container{display:flex;min-height:100%;justify-content:center;align-items:center}@media screen and (min-height:376px){:host(tb-login) .login-container{min-height:100%;padding:30px 0}}:host(tb-login) .login-container .container{display:flex;flex-direction:row-reverse;flex-wrap:nowrap;min-height:50vh}@media screen and (min-width:576px){:host(tb-login) .login-container .container{min-height:70vh}}:host(tb-login) .login-container .container .intro{background:#00578c;padding:30px 50px;display:flex;flex-direction:column;flex-wrap:nowrap;flex:1;justify-content:space-between}:host(tb-login) .login-container .container .intro img{align-self:flex-start}:host(tb-login) .login-container .container .intro .welcome h2{font-size:30px;font-weight:300;color:#fff;margin:-50px 0 30px}:host(tb-login) .login-container .container .intro .welcome h2 strong{font-weight:400;font-size:40px}:host(tb-login) .login-container .container .intro .welcome p{color:#fff;font-size:14px;font-weight:300;line-height:1.4em}:host(tb-login) .login-container .container .login{flex:1;display:flex;padding:10px 20px;flex-direction:column;justify-content:center;background:#0277bd}@media screen and (min-width:992px){:host(tb-login) .login-container .container .login{flex:40% 0}}:host(tb-login) .login-container .container .login .login-header{display:flex;flex-direction:row;justify-content:space-between;align-items:center}:host(tb-login) .login-container .container .login .login-header img{width:150px}:host(tb-login) .login-container .container .login .login-header h3{color:#fff;font-size:30px;margin:0;font-weight:300}:host(tb-login) .login-container .container .login .login-form{display:flex;flex-direction:column;justify-content:center;margin:40px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container{width:100%;margin:3px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container>.k-label{font-weight:300;color:#8ee2ff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-input.k-textbox,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textarea,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textbox{border:none;border-bottom:1px solid #8ee2ff;border-radius:0;color:#fff;background:#0277bd;box-shadow:none;padding:10px 0;height:36px;caret-color:#fff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container::after{background-color:#8ee2ff;height:1px}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown{border:none;background:0 0;border-bottom:1px solid #8ee2ff!important}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap{border:none;border-radius:0;padding:0;box-shadow:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap>.k-input{background:#0277bd!important;height:36px;opacity:1;color:#fff;padding:0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled{opacity:1;color:#fff;-webkit-filter:none;filter:none;border-bottom:1px dashed #8ee2ff;background:#0277bd}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled .k-select{display:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select{color:#8ee2ff;opacity:1;background:#0277bd;border-radius:0;border:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select .k-icon{color:#8ee2ff}:host(tb-login) .login-container .container .login .login-infos{margin:20px 0}:host(tb-login) .login-container .container .login .login-infos .caps-lock{margin:0 0 10px;background:#00578c;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em;display:flex;align-items:center}:host(tb-login) .login-container .container .login .login-infos .caps-lock span{margin-right:5px}:host(tb-login) .login-container .container .login .login-infos .login-error{margin:0 0 10px;background:#ff6358;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em}:host(tb-login) .login-container .container .login .login-infos .login-error span{margin-right:5px}:host(tb-login) .login-container .container .login .login-footer{display:flex;flex-direction:row;justify-content:flex-end;align-items:center}:host(tb-login) .login-container .container .login .login-footer .login-button{padding:10px 70px;background:#3daf68;color:#fff}:host(tb-login) .login-container .container .login .login-footer .login-button.k-state-disabled{background-color:rgba(0,87,140,.5);border-color:#00598e;color:#54aee4;cursor:not-allowed}:host(tb-login) .login-container .container .login .login-footer .login-button .k-i-loading{font-size:20px}:host(tb-login) .login-container .container .login .login-footer .server-info{display:flex;flex-direction:row;align-items:center;margin-right:10px}:host(tb-login) .login-container .container .login .login-footer .server-info #server-info-label{font-size:11px;font-weight:300;color:#fff;margin:0 10px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon{color:#fff;font-size:20px;padding-top:3px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon .k-icon{margin-top:-8px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon m4-icon{cursor:pointer}:host(tb-login) .login-container .container .login .login-footer .server-info.server-down #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-down .icon{color:#ffc000}:host(tb-login) .login-container .container .login .login-footer .server-info.server-up #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-up .icon{color:#3daf68}:host(tb-login) p.copyright{font-size:10px;font-weight:300;margin:0;color:#fff}:host(tb-login) p.copyright-abs{position:absolute;bottom:5px;color:#ccc;text-align:center;width:100%}:host(tb-login) .server-info-popup{padding:5px 7px;min-width:150px;background:#013b5e}:host(tb-login) .server-info-popup h3{font-size:20px;color:#fff;font-weight:300;margin:0 0 10px;text-align:center}:host(tb-login) .server-info-popup a.tb-btn{padding:7px 7px 5px;text-align:center;background:#0277bd;color:#fff;margin:10px 0;display:block;border-radius:4px;border:1px solid #00578c}:host(tb-login) .server-info-popup .dl-horizontal{margin:0;padding:0 20px 0 0;color:#fff}:host(tb-login) .server-info-popup .dl-horizontal dt{float:left;width:80px;overflow:hidden;clear:left;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-size:12px;font-weight:500}:host(tb-login) .server-info-popup .dl-horizontal dd{margin-left:90px;font-size:12px;font-weight:300}:host(tb-login) input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px #0277bd inset!important;-webkit-text-fill-color:#fff!important}:host(tb-login) :focus{outline:0}@media (min-width:576px){:host(tb-login) .container .login{padding:20px}:host(tb-login) .container .login .login-form ::ng-deep .k-textbox-container{margin:10px 0}}@media (min-width:992px){:host(tb-login) .container .login .login-header{justify-content:flex-end}}']}]}],j.ctorParameters=function(){return[{type:y},{type:r.Router},{type:undefined,decorators:[{type:a.Inject,args:["env"]}]}]},j);function j(n,o,e){this.authService=n,this.router=o,this.env=e,this.capsLockOn=!1,this.loading=!1,this.loginRequest=new d,this.loginRequest.AppId=e.auth.appid}var T=(A.decorators=[{type:a.Component,args:[{selector:"tb-logout",template:""}]}],A.ctorParameters=function(){return[{type:y},{type:r.Router}]},A);function A(n,o){this.authService=n,this.router=o}var C=(q.forRoot=function(){return{ngModule:q,providers:[y]}},q.decorators=[{type:a.NgModule,args:[{declarations:[R,T],imports:[l.CommonModule,s.FormsModule,c.InputsModule,g.ButtonsModule],exports:[R,T]}]}],q);function q(){}n.Instance=p,n.LoginRequest=d,n.LoginResponse=u,n.StorageVars=f,n.Subscription=b,n.Token=m,n.TbAuthService=y,n.TbAuthGuard=S,n.TbAuthInterceptor=I,n.TbLoginComponent=R,n.TbLogoutComponent=T,n.TbAuthModule=C,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=tb-auth.umd.min.js.map