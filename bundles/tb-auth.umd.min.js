!function(o,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("moment"),require("@angular/router"),require("@angular/core"),require("@angular/common"),require("@angular/forms"),require("@progress/kendo-angular-inputs"),require("@progress/kendo-angular-buttons")):"function"==typeof define&&define.amd?define("@tb/auth",["exports","@angular/common/http","rxjs","rxjs/operators","moment","@angular/router","@angular/core","@angular/common","@angular/forms","@progress/kendo-angular-inputs","@progress/kendo-angular-buttons"],n):n((o.tb=o.tb||{},o.tb.auth={}),o.ng.common.http,o.rxjs,o.rxjs.operators,o.moment_,o.ng.router,o.ng.core,o.ng.common,o.ng.forms,o.kendoAngularInputs,o.kendoAngularButtons)}(this,function(o,n,i,r,e,t,a,l,s,c,g){"use strict";function p(n,a,l,s){return new(l||(l=Promise))(function(o,e){function t(o){try{r(s.next(o))}catch(n){e(n)}}function i(o){try{r(s["throw"](o))}catch(n){e(n)}}function r(n){n.done?o(n.value):new l(function(o){o(n.value)}).then(t,i)}r((s=s.apply(n,a||[])).next())})}function u(t,i){var r,a,l,o,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return o={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function n(n){return function(o){return function e(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,a&&(l=2&o[0]?a["return"]:o[0]?a["throw"]||((l=a["return"])&&l.call(a),0):a.next)&&!(l=l.call(a,o[1])).done)return l;switch(a=0,l&&(o=[2&o[0],l.value]),o[0]){case 0:case 1:l=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,a=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!l||o[1]>l[0]&&o[1]<l[3])){s.label=o[1];break}if(6===o[0]&&s.label<l[1]){s.label=l[1],l=o;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(o);break}l[2]&&s.ops.pop(),s.trys.pop();continue}o=i.call(t,s)}catch(n){o=[6,n],a=0}finally{r=l=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([n,o])}}}var d=(f.JWT="M4_jwt_token",f.EXP="M4_jwt_token_expiration_date",f.CULTURE="M4_culture",f.UI_CULTURE="M4_ui_culture",f.ACCOUNT_NAME="M4_account_name",f);function f(){}var h=e,b=(m.prototype.isValidToken=function(t){return void 0===t&&(t=null),p(this,void 0,void 0,function(){var n,e=this;return u(this,function(o){return n=localStorage.getItem(d.JWT),console.log("isValidToken - authtoken",n),n||t?[2,this.http.post(this.getIsValidTokenUrl(),t||{}).pipe(r.tap(function(o){console.log("isValidToken - response",o),o.Result||(o.Message=o.Message?o.Message:"isValidToken error...",e.clearStorage(),e.errorMessage=o.Message)})).toPromise()]:[2,i.of(!1)]})})},m.prototype.login=function(o){var n=this;return this.http.post(this.getLoginUrl(),o).pipe(r.map(function(o){return o.Result?n.storageData(o):(n.clearStorage(),o.Message=o.Message?o.Message:"Login error...",n.errorMessage=o.Message),o}))},m.prototype.storageData=function(o){var n=o.Culture===undefined||0===o.Culture.length?window.navigator.language:o.Culture,e=o.UICulture===undefined||0===o.UICulture.length?window.navigator.language:o.UICulture;this.saveCulture(n,e),localStorage.setItem(d.JWT,o.JwtToken);var t=o.Exp?h(o.Exp):h().add(1,"day");localStorage.setItem(d.EXP,JSON.stringify(t.valueOf()))},m.prototype.getIsValidTokenUrl=function(){return this.getBaseUrl()+"token/"},m.prototype.getLoginUrl=function(){return this.getBaseUrl()+"tokens/"},m.prototype.getLogoutUrl=function(){return this.getBaseUrl()+"logout/"},m.prototype.getRedirectUrl=function(){return this.redirectUrl},m.prototype.setRedirectUrl=function(o){this.redirectUrl=o},m.prototype.getBaseUrl=function(){return this.loginUrl||(this.loginUrl=this.env.auth.url),this.loginUrl},m.prototype.logoff=function(){},m.prototype.saveCulture=function(o,n){void 0===o&&(o=""),void 0===n&&(n=""),localStorage.setItem(d.CULTURE,o),localStorage.setItem(d.UI_CULTURE,n)},m.prototype.clearStorage=function(){localStorage.removeItem(d.JWT),localStorage.removeItem(d.EXP),localStorage.removeItem(d.CULTURE),localStorage.removeItem(d.UI_CULTURE)},m.prototype.isExpired=function(){var o=localStorage.getItem(d.EXP);if(!o)return!1;var n=JSON.parse(o);return h().isAfter(h(n))},m.decorators=[{type:a.Injectable,args:[{providedIn:"root"}]}],m.ctorParameters=function(){return[{type:undefined,decorators:[{type:a.Inject,args:["env"]}]},{type:n.HttpClient},{type:t.Router}]},m.ngInjectableDef=a.defineInjectable({factory:function(){return new m(a.inject("env"),a.inject(n.HttpClient),a.inject(t.Router))},token:m,providedIn:"root"}),m);function m(o,n,e){this.env=o,this.http=n,this.router=e,this.redirectUrl="/"}var x=(v.prototype.canActivate=function(r,a){return p(this,void 0,void 0,function(){var n,e,t,i;return u(this,function(o){switch(o.label){case 0:return console.log("ActivatedRouteSnapshot",r,a.url),e=r.queryParams.hasOwnProperty("jwt")?r.queryParams.jwt:null,t=r.queryParams.hasOwnProperty("subKey")?r.queryParams.subKey:null,e&&t&&(n={JwtToken:e,SubscriptionKey:t}),!n&&this.authService.isExpired()?(this.authService.errorMessage="Token expired",this.authService.clearStorage(),this.router.navigate(["login"]),[2,!0]):localStorage.getItem(d.JWT)||n?[4,this.authService.isValidToken(n)]:[3,2];case 1:return i=o.sent(),console.log("isValidToken",i),i.Result?[2,!0]:(this.router.navigate(["login"]),[2,!1]);case 2:return this.router.navigate(["login"]),[2,!0];case 3:return[2]}})})},v.decorators=[{type:a.Injectable,args:[{providedIn:"root"}]}],v.ctorParameters=function(){return[{type:b},{type:t.Router}]},v.ngInjectableDef=a.defineInjectable({factory:function(){return new v(a.inject(b),a.inject(t.Router))},token:v,providedIn:"root"}),v);function v(o,n){this.authService=o,this.router=n}var k=(w.prototype.intercept=function(o,n){var e=JSON.stringify({token:localStorage.getItem(d.JWT)});return e&&(o=o.clone({setHeaders:{Authorization:e}})),n.handle(o).pipe()},w.decorators=[{type:a.Injectable}],w.ctorParameters=function(){return[]},w);function w(){}var y=function C(){this.accountName="",this.password="",this.subscriptionKey=null,this.appid="GENERIC"},S=(U.prototype.ngOnInit=function(){this.loadAccountName()},U.prototype.keyUpFunction=function(o){13===o.keyCode&&this.loginRequest.accountName&&this.login();var n=o.getModifierState&&o.getModifierState("CapsLock");this.capsLockOn=n},U.prototype.disabledButton=function(){return!this.loginRequest.accountName||this.loading},U.prototype.accountNameBlur=function(){},U.prototype.login=function(){return p(this,void 0,void 0,function(){var n,e,t=this;return u(this,function(o){switch(o.label){case 0:return this.authService.errorMessage="",this.saveAccountName(),this.loading=!0,[4,this.authService.login(this.loginRequest).toPromise()["catch"](function(o){t.loading=!1,console.error("Login Error",o),t.authService.errorMessage=o.error&&o.error.Message})];case 1:return n=o.sent(),this.loading=!1,n&&(n.Result?(e=this.authService.getRedirectUrl(),console.log("Redirect Url",e),this.authService.errorMessage="",this.router.navigate([e])):(console.error("authService.errorMessage:",this.authService.errorMessage),this.loading=!1)),[2]}})})},U.prototype.loadAccountName=function(){this.loginRequest.accountName=localStorage.getItem(d.ACCOUNT_NAME)},U.prototype.saveAccountName=function(){localStorage.setItem(d.ACCOUNT_NAME,this.loginRequest.accountName)},U.decorators=[{type:a.Component,args:[{selector:"tb-login",template:'<div class="login-container">\n    <div class="container">\n        <div class=" login">\n            <div class="login-header">\n                <img class="d-lg-none" src="assets/images/logoM4_w160.png" />\n                <h3>Sign in</h3>\n            </div>\n\n            <div class="login-form">\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Account Name">\n                        <input\n                            kendoTextBox\n                            autofocus\n                            [(ngModel)]="loginRequest.accountName"\n                            (blur)="accountNameBlur()"\n                            (keyup)="keyUpFunction($event)"\n                            name="accountName"\n                            autocomplete="off"\n                        />\n                    </kendo-textbox-container>\n                </div>\n\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Password">\n                        <input\n                            kendoTextBox\n                            [(ngModel)]="loginRequest.password"\n                            (keyup)="keyUpFunction($event)"\n                            name="password"\n                            type="password"\n                            autocomplete="new-password"\n                        />\n                    </kendo-textbox-container>\n                </div>\n            </div>\n\n            <div class="caps-lock" *ngIf="capsLockOn"><span class="k-icon k-i-warning"></span> Caps lock on</div>\n            <div class="login-error" *ngIf="authService.errorMessage">\n                <span class="k-icon k-i-warning"></span>{{ authService.errorMessage }}\n            </div>\n\n            <div class="login-footer">\n                <div class="login-button-container">\n                    <button kendoButton class="login-button" (click)="login()" [disabled]="disabledButton()">\n                        <span class="k-icon k-i-loading" *ngIf="loading"></span>\n                        <span *ngIf="!loading">Login</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n        <div class="intro d-none d-lg-flex">\n            <img src="assets/images/logoM4_w160.png" />\n\n            <div class="welcome">\n                <h2>Welcome to <strong>M4Cloud</strong></h2>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n            </div>\n\n            <p class="d-md-block">&nbsp;</p>\n        </div>\n    </div>\n</div>\n<p class="copyright copyright-abs">© 2017 - 2019 Zucchetti s.p.a.</p>\n',styles:[':host(tb-login){font-family:"Fira Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"!important;background:#013b5e;display:block;min-height:100vh;padding:0;margin:0;overflow:auto;height:100%}:host(tb-login) .login-container{display:flex;min-height:100%;justify-content:center;align-items:center}@media screen and (min-height:376px){:host(tb-login) .login-container{min-height:90%;margin:30px 0}}:host(tb-login) .login-container .container{display:flex;flex-direction:row-reverse;flex-wrap:nowrap;min-height:50vh}@media screen and (min-width:576px){:host(tb-login) .login-container .container{min-height:70vh}}@media screen and (min-width:1025px){:host(tb-login) .login-container .container{min-height:80vh}}:host(tb-login) .login-container .container .intro{background:#00578c;padding:30px 50px;display:flex;flex-direction:column;flex-wrap:nowrap;flex:1;justify-content:space-between}:host(tb-login) .login-container .container .intro img{align-self:flex-start}:host(tb-login) .login-container .container .intro .welcome h2{font-size:30px;font-weight:300;color:#fff;margin:-50px 0 30px}:host(tb-login) .login-container .container .intro .welcome h2 strong{font-weight:400;font-size:40px}:host(tb-login) .login-container .container .intro .welcome p{color:#fff;font-size:14px;font-weight:300;line-height:1.4em}:host(tb-login) .login-container .container .login{flex:1;display:flex;padding:10px 20px;flex-direction:column;justify-content:space-between;background:#0277bd}@media screen and (min-width:992px){:host(tb-login) .login-container .container .login{flex:40% 0}}:host(tb-login) .login-container .container .login .login-header{display:flex;flex-direction:row;justify-content:space-between;align-items:center}:host(tb-login) .login-container .container .login .login-header img{width:150px}:host(tb-login) .login-container .container .login .login-header h3{color:#fff;font-size:30px;margin:0;font-weight:300}:host(tb-login) .login-container .container .login .login-form{display:flex;flex-direction:column;flex:1;justify-content:center;margin:10px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container{width:100%;margin:3px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container>.k-label{font-weight:300;color:#8ee2ff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-input.k-textbox,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textarea,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textbox{border:none;border-bottom:1px solid #8ee2ff;border-radius:0;color:#fff;background:#0277bd;box-shadow:none;padding:10px 0;height:36px;caret-color:#fff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container::after{background-color:#8ee2ff;height:1px}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown{border:none;background:0 0;border-bottom:1px solid #8ee2ff!important}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap{border:none;border-radius:0;padding:0;box-shadow:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap>.k-input{background:#0277bd!important;height:36px;opacity:1;color:#fff;padding:0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled{opacity:1;color:#fff;-webkit-filter:none;filter:none;border-bottom:1px dashed #8ee2ff;background:#0277bd}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled .k-select{display:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select{color:#8ee2ff;opacity:1;background:#0277bd;border-radius:0;border:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select .k-icon{color:#8ee2ff}:host(tb-login) .login-container .container .login .caps-lock{margin:0 0 10px;background:#00578c;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em;display:flex;align-items:center}:host(tb-login) .login-container .container .login .caps-lock span{margin-right:5px}:host(tb-login) .login-container .container .login .login-error{margin:0 0 10px;background:#ff6358;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em}:host(tb-login) .login-container .container .login .login-error span{margin-right:5px}:host(tb-login) .login-container .container .login .login-footer{display:flex;flex-direction:row;justify-content:flex-end;align-items:center}:host(tb-login) .login-container .container .login .login-footer .login-button{padding:10px 70px;background:#3daf68;color:#fff}:host(tb-login) .login-container .container .login .login-footer .login-button.k-state-disabled{background-color:rgba(0,87,140,.5);border-color:#00598e;color:#54aee4;cursor:not-allowed}:host(tb-login) .login-container .container .login .login-footer .login-button .k-i-loading{font-size:20px}:host(tb-login) .login-container .container .login .login-footer .server-info{display:flex;flex-direction:row;align-items:center;margin-right:10px}:host(tb-login) .login-container .container .login .login-footer .server-info #server-info-label{font-size:11px;font-weight:300;color:#fff;margin:0 10px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon{color:#fff;font-size:20px;padding-top:3px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon .k-icon{margin-top:-8px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon m4-icon{cursor:pointer}:host(tb-login) .login-container .container .login .login-footer .server-info.server-down #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-down .icon{color:#ffc000}:host(tb-login) .login-container .container .login .login-footer .server-info.server-up #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-up .icon{color:#3daf68}:host(tb-login) p.copyright{font-size:10px;font-weight:300;margin:0;color:#fff}:host(tb-login) p.copyright-abs{position:absolute;bottom:5px;color:#ccc;text-align:center;width:100%}:host(tb-login) .server-info-popup{padding:5px 7px;min-width:150px;background:#013b5e}:host(tb-login) .server-info-popup h3{font-size:20px;color:#fff;font-weight:300;margin:0 0 10px;text-align:center}:host(tb-login) .server-info-popup a.tb-btn{padding:7px 7px 5px;text-align:center;background:#0277bd;color:#fff;margin:10px 0;display:block;border-radius:4px;border:1px solid #00578c}:host(tb-login) .server-info-popup .dl-horizontal{margin:0;padding:0 20px 0 0;color:#fff}:host(tb-login) .server-info-popup .dl-horizontal dt{float:left;width:80px;overflow:hidden;clear:left;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-size:12px;font-weight:500}:host(tb-login) .server-info-popup .dl-horizontal dd{margin-left:90px;font-size:12px;font-weight:300}:host(tb-login) input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px #0277bd inset!important;-webkit-text-fill-color:#fff!important}:host(tb-login) :focus{outline:0}@media (min-width:576px){:host(tb-login) .container .login{padding:20px}:host(tb-login) .container .login .login-form ::ng-deep .k-textbox-container{margin:10px 0}}@media (min-width:992px){:host(tb-login) .container .login .login-header{justify-content:flex-end}}']}]}],U.ctorParameters=function(){return[{type:b},{type:t.Router}]},U);function U(o,n){this.authService=o,this.router=n,this.capsLockOn=!1,this.loading=!1,this.loginRequest=new y}var I=(M.decorators=[{type:a.Component,args:[{selector:"tb-logout",template:""}]}],M.ctorParameters=function(){return[{type:b},{type:t.Router}]},M);function M(o,n){this.authService=o,this.router=n}var T=(j.forRoot=function(){return{ngModule:j,providers:[b]}},j.decorators=[{type:a.NgModule,args:[{declarations:[S,I],imports:[l.CommonModule,s.FormsModule,c.InputsModule,g.ButtonsModule],exports:[S,I]}]}],j);function j(){}o.TbAuthService=b,o.TbAuthGuard=x,o.TbAuthInterceptor=k,o.TbLoginComponent=S,o.TbLogoutComponent=I,o.TbAuthModule=T,Object.defineProperty(o,"__esModule",{value:!0})});
//# sourceMappingURL=tb-auth.umd.min.js.map