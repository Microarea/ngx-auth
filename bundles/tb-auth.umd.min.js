!function(n,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("@angular/common/http"),require("rxjs"),require("rxjs/operators"),require("@angular/router"),require("@angular/core"),require("@angular/common"),require("@angular/forms"),require("@progress/kendo-angular-inputs"),require("@progress/kendo-angular-buttons")):"function"==typeof define&&define.amd?define("@tb/auth",["exports","@angular/common/http","rxjs","rxjs/operators","@angular/router","@angular/core","@angular/common","@angular/forms","@progress/kendo-angular-inputs","@progress/kendo-angular-buttons"],o):o((n.tb=n.tb||{},n.tb.auth={}),n.ng.common.http,n.rxjs,n.rxjs.operators,n.ng.router,n.ng.core,n.ng.common,n.ng.forms,n.kendoAngularInputs,n.kendoAngularButtons)}(this,function(n,o,i,r,e,t,a,l,s,c){"use strict";function g(o,a,l,s){return new(l||(l=Promise))(function(n,e){function t(n){try{r(s.next(n))}catch(o){e(o)}}function i(n){try{r(s["throw"](n))}catch(o){e(o)}}function r(o){o.done?n(o.value):new l(function(n){n(o.value)}).then(t,i)}r((s=s.apply(o,a||[])).next())})}function p(t,i){var r,a,l,n,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return n={next:o(0),"throw":o(1),"return":o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(n){return function e(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,a&&(l=2&n[0]?a["return"]:n[0]?a["throw"]||((l=a["return"])&&l.call(a),0):a.next)&&!(l=l.call(a,n[1])).done)return l;switch(a=0,l&&(n=[2&n[0],l.value]),n[0]){case 0:case 1:l=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,a=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!l||n[1]>l[0]&&n[1]<l[3])){s.label=n[1];break}if(6===n[0]&&s.label<l[1]){s.label=l[1],l=n;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(n);break}l[2]&&s.ops.pop(),s.trys.pop();continue}n=i.call(t,s)}catch(o){n=[6,o],a=0}finally{r=l=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([o,n])}}}var u=(d.JWT="M4_jwt_token",d.CULTURE="M4_culture",d.UI_CULTURE="M4_ui_culture",d.ACCOUNT_NAME="M4_account_name",d);function d(){}var f=(h.prototype.isValidToken=function(t){return void 0===t&&(t=null),g(this,void 0,void 0,function(){var o,e=this;return p(this,function(n){return o=sessionStorage.getItem(u.JWT),console.log("isValidToken - authtoken",o),o||t?[2,this.http.post(this.getIsValidTokenUrl(),t||{}).pipe(r.tap(function(n){console.log("isValidToken - response",n),n.Result||(n.Message=n.Message?n.Message:"Login error...",e.errorMessage=n.Message)})).toPromise()]:[2,i.of(!1)]})})},h.prototype.login=function(n){var t=this;return this.http.post(this.getLoginUrl(),n).pipe(r.map(function(n){var o=n.Culture===undefined||0===n.Culture.length?window.navigator.language:n.Culture,e=n.UICulture===undefined||0===n.UICulture.length?window.navigator.language:n.UICulture;return t.saveCulture(o,e),n.Result?sessionStorage.setItem(u.JWT,n.JwtToken):(n.Message=n.Message?n.Message:"Login error...",sessionStorage.removeItem(u.JWT),t.errorMessage=n.Message),n}))},h.prototype.getIsValidTokenUrl=function(){return this.getBaseUrl()+"token/"},h.prototype.getLoginUrl=function(){return this.getBaseUrl()+"tokens/"},h.prototype.getLogoutUrl=function(){return this.getBaseUrl()+"logout/"},h.prototype.getRedirectUrl=function(){return this.redirectUrl},h.prototype.setRedirectUrl=function(n){this.redirectUrl=n},h.prototype.getBaseUrl=function(){return this.loginUrl||(this.loginUrl=this.env.auth.url),this.loginUrl},h.prototype.logoff=function(){},h.prototype.saveCulture=function(n,o){void 0===n&&(n=""),void 0===o&&(o=""),localStorage.setItem(u.CULTURE,n),localStorage.setItem(u.UI_CULTURE,o)},h.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],h.ctorParameters=function(){return[{type:undefined,decorators:[{type:t.Inject,args:["env"]}]},{type:o.HttpClient},{type:e.Router}]},h.ngInjectableDef=t.defineInjectable({factory:function(){return new h(t.inject("env"),t.inject(o.HttpClient),t.inject(e.Router))},token:h,providedIn:"root"}),h);function h(n,o,e){this.env=n,this.http=o,this.router=e,this.redirectUrl="/"}var b=(m.prototype.canActivate=function(r,a){return g(this,void 0,void 0,function(){var o,e,t,i;return p(this,function(n){switch(n.label){case 0:return console.log("ActivatedRouteSnapshot",r,a.url),e=r.queryParams.hasOwnProperty("jwt")?r.queryParams.jwt:null,t=r.queryParams.hasOwnProperty("subKey")?r.queryParams.subKey:null,e&&t&&(o={JwtToken:e,SubscriptionKey:t}),sessionStorage.getItem(u.JWT)||o?[4,this.authService.isValidToken(o)]:[3,2];case 1:return i=n.sent(),console.log("isValidToken",i),i.Success?[2,!0]:(this.router.navigate(["login"]),[2,!1]);case 2:return this.router.navigate(["login"]),[2,!0];case 3:return[2]}})})},m.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],m.ctorParameters=function(){return[{type:f},{type:e.Router}]},m.ngInjectableDef=t.defineInjectable({factory:function(){return new m(t.inject(f),t.inject(e.Router))},token:m,providedIn:"root"}),m);function m(n,o){this.authService=n,this.router=o}var x=(v.prototype.intercept=function(n,o){var e=JSON.stringify({token:sessionStorage.getItem(u.JWT)});return e&&(n=n.clone({setHeaders:{Authorization:e}})),o.handle(n).pipe()},v.decorators=[{type:t.Injectable}],v.ctorParameters=function(){return[]},v);function v(){}var k=function j(){this.accountName="",this.password=""},w=(y.prototype.ngOnInit=function(){this.loadAccountName()},y.prototype.keyUpFunction=function(n){13===n.keyCode&&this.loginRequest.accountName&&this.login();var o=n.getModifierState&&n.getModifierState("CapsLock");this.capsLockOn=o},y.prototype.disabledButton=function(){return!this.loginRequest.accountName||this.loading},y.prototype.accountNameBlur=function(){},y.prototype.login=function(){return g(this,void 0,void 0,function(){var o,e,t=this;return p(this,function(n){switch(n.label){case 0:return this.authService.errorMessage="",this.saveAccountName(),this.loading=!0,[4,this.authService.login(this.loginRequest).toPromise()["catch"](function(n){t.loading=!1,console.error("Login Error",n),t.authService.errorMessage=n.error&&n.error.Message})];case 1:return(o=n.sent())&&(o.Result?(e=this.authService.getRedirectUrl(),console.log("Redirect Url",e),this.authService.errorMessage="",this.router.navigate([e])):(console.error("authService.errorMessage:",this.authService.errorMessage),this.loading=!1)),[2]}})})},y.prototype.loadAccountName=function(){this.loginRequest.accountName=localStorage.getItem(u.ACCOUNT_NAME)},y.prototype.saveAccountName=function(){localStorage.setItem(u.ACCOUNT_NAME,this.loginRequest.accountName)},y.decorators=[{type:t.Component,args:[{selector:"tb-login",template:'<div class="login-container">\n    <div class="container">\n        <div class=" login">\n            <div class="login-header">\n                <img class="d-lg-none" src="assets/images/logoM4_w160.png" />\n                <h3>Sign in</h3>\n            </div>\n\n            <div class="login-form">\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Account Name">\n                        <input\n                            kendoTextBox\n                            autofocus\n                            [(ngModel)]="loginRequest.accountName"\n                            (blur)="accountNameBlur()"\n                            (keyup)="keyUpFunction($event)"\n                            name="accountName"\n                            autocomplete="off"\n                        />\n                    </kendo-textbox-container>\n                </div>\n\n                <div class="form-control">\n                    <kendo-textbox-container floatingLabel="Password">\n                        <input\n                            kendoTextBox\n                            [(ngModel)]="loginRequest.password"\n                            (keyup)="keyUpFunction($event)"\n                            name="password"\n                            type="password"\n                            autocomplete="new-password"\n                        />\n                    </kendo-textbox-container>\n                </div>\n            </div>\n\n            <div class="caps-lock" *ngIf="capsLockOn"><span class="k-icon k-i-warning"></span> Caps lock on</div>\n            <div class="login-error" *ngIf="authService.errorMessage">\n                <span class="k-icon k-i-warning"></span>{{ authService.errorMessage }}\n            </div>\n\n            <div class="login-footer">\n                <div class="login-button-container">\n                    <button kendoButton class="login-button" (click)="login()" [disabled]="disabledButton()">\n                        <span class="k-icon k-i-loading" *ngIf="loading"></span>\n                        <span *ngIf="!loading">Login</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n        <div class="intro d-none d-lg-flex">\n            <img src="assets/images/logoM4_w160.png" />\n\n            <div class="welcome">\n                <h2>Welcome to <strong>M4Cloud</strong></h2>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n\n                <p>\n                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna\n                    aliqua. Ut enim ad minim veniam.\n                </p>\n            </div>\n\n            <p class="d-md-block">&nbsp;</p>\n        </div>\n    </div>\n</div>\n<p class="copyright copyright-abs">Â© 2017 - 2019 Zucchetti s.p.a.</p>\n',styles:[':host(tb-login){font-family:"Fira Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"!important;background:#013b5e;display:block;min-height:100vh;padding:0;margin:0;overflow:auto;height:100%}:host(tb-login) .login-container{display:flex;min-height:100%;justify-content:center;align-items:center}@media screen and (min-height:376px){:host(tb-login) .login-container{min-height:90%;margin:30px 0}}:host(tb-login) .login-container .container{display:flex;flex-direction:row-reverse;flex-wrap:nowrap;min-height:50vh}@media screen and (min-width:576px){:host(tb-login) .login-container .container{min-height:70vh}}@media screen and (min-width:1025px){:host(tb-login) .login-container .container{min-height:80vh}}:host(tb-login) .login-container .container .intro{background:#00578c;padding:30px 50px;display:flex;flex-direction:column;flex-wrap:nowrap;flex:1;justify-content:space-between}:host(tb-login) .login-container .container .intro img{align-self:flex-start}:host(tb-login) .login-container .container .intro .welcome h2{font-size:30px;font-weight:300;color:#fff;margin:-50px 0 30px}:host(tb-login) .login-container .container .intro .welcome h2 strong{font-weight:400;font-size:40px}:host(tb-login) .login-container .container .intro .welcome p{color:#fff;font-size:14px;font-weight:300;line-height:1.4em}:host(tb-login) .login-container .container .login{flex:1;display:flex;padding:10px 20px;flex-direction:column;justify-content:space-between;background:#0277bd}@media screen and (min-width:992px){:host(tb-login) .login-container .container .login{flex:40% 0}}:host(tb-login) .login-container .container .login .login-header{display:flex;flex-direction:row;justify-content:space-between;align-items:center}:host(tb-login) .login-container .container .login .login-header img{width:150px}:host(tb-login) .login-container .container .login .login-header h3{color:#fff;font-size:30px;margin:0;font-weight:300}:host(tb-login) .login-container .container .login .login-form{display:flex;flex-direction:column;flex:1;justify-content:center;margin:10px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container{width:100%;margin:3px 0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container>.k-label{font-weight:300;color:#8ee2ff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-input.k-textbox,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textarea,:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-textbox{border:none;border-bottom:1px solid #8ee2ff;border-radius:0;color:#fff;background:#0277bd;box-shadow:none;padding:10px 0;height:36px;caret-color:#fff}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container::after{background-color:#8ee2ff;height:1px}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown{border:none;background:0 0;border-bottom:1px solid #8ee2ff!important}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap{border:none;border-radius:0;padding:0;box-shadow:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap>.k-input{background:#0277bd!important;height:36px;opacity:1;color:#fff;padding:0}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled{opacity:1;color:#fff;-webkit-filter:none;filter:none;border-bottom:1px dashed #8ee2ff;background:#0277bd}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap.k-state-disabled .k-select{display:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select{color:#8ee2ff;opacity:1;background:#0277bd;border-radius:0;border:none}:host(tb-login) .login-container .container .login .login-form ::ng-deep .k-textbox-container .k-dropdown .k-dropdown-wrap .k-select .k-icon{color:#8ee2ff}:host(tb-login) .login-container .container .login .caps-lock{margin:0 0 10px;background:#00578c;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em;display:flex;align-items:center}:host(tb-login) .login-container .container .login .caps-lock span{margin-right:5px}:host(tb-login) .login-container .container .login .login-error{margin:0 0 10px;background:#ff6358;color:#fff;font-size:13px;font-weight:300;padding:5px 10px;line-height:1.8em}:host(tb-login) .login-container .container .login .login-error span{margin-right:5px}:host(tb-login) .login-container .container .login .login-footer{display:flex;flex-direction:row;justify-content:flex-end;align-items:center}:host(tb-login) .login-container .container .login .login-footer .login-button{padding:10px 70px;background:#3daf68;color:#fff}:host(tb-login) .login-container .container .login .login-footer .login-button.k-state-disabled{background-color:rgba(0,87,140,.5);border-color:#00598e;color:#54aee4;cursor:not-allowed}:host(tb-login) .login-container .container .login .login-footer .login-button .k-i-loading{font-size:20px}:host(tb-login) .login-container .container .login .login-footer .server-info{display:flex;flex-direction:row;align-items:center;margin-right:10px}:host(tb-login) .login-container .container .login .login-footer .server-info #server-info-label{font-size:11px;font-weight:300;color:#fff;margin:0 10px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon{color:#fff;font-size:20px;padding-top:3px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon .k-icon{margin-top:-8px}:host(tb-login) .login-container .container .login .login-footer .server-info .icon m4-icon{cursor:pointer}:host(tb-login) .login-container .container .login .login-footer .server-info.server-down #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-down .icon{color:#ffc000}:host(tb-login) .login-container .container .login .login-footer .server-info.server-up #server-info-label,:host(tb-login) .login-container .container .login .login-footer .server-info.server-up .icon{color:#3daf68}:host(tb-login) p.copyright{font-size:10px;font-weight:300;margin:0;color:#fff}:host(tb-login) p.copyright-abs{position:absolute;bottom:5px;color:#ccc;text-align:center;width:100%}:host(tb-login) .server-info-popup{padding:5px 7px;min-width:150px;background:#013b5e}:host(tb-login) .server-info-popup h3{font-size:20px;color:#fff;font-weight:300;margin:0 0 10px;text-align:center}:host(tb-login) .server-info-popup a.tb-btn{padding:7px 7px 5px;text-align:center;background:#0277bd;color:#fff;margin:10px 0;display:block;border-radius:4px;border:1px solid #00578c}:host(tb-login) .server-info-popup .dl-horizontal{margin:0;padding:0 20px 0 0;color:#fff}:host(tb-login) .server-info-popup .dl-horizontal dt{float:left;width:80px;overflow:hidden;clear:left;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-size:12px;font-weight:500}:host(tb-login) .server-info-popup .dl-horizontal dd{margin-left:90px;font-size:12px;font-weight:300}:host(tb-login) input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px #0277bd inset!important;-webkit-text-fill-color:#fff!important}:host(tb-login) :focus{outline:0}@media (min-width:576px){:host(tb-login) .container .login{padding:20px}:host(tb-login) .container .login .login-form ::ng-deep .k-textbox-container{margin:10px 0}}@media (min-width:992px){:host(tb-login) .container .login .login-header{justify-content:flex-end}}']}]}],y.ctorParameters=function(){return[{type:f},{type:e.Router}]},y);function y(n,o){this.authService=n,this.router=o,this.capsLockOn=!1,this.loading=!1,this.loginRequest=new k}var U=(M.decorators=[{type:t.Component,args:[{selector:"tb-logout",template:""}]}],M.ctorParameters=function(){return[{type:f},{type:e.Router}]},M);function M(n,o){this.authService=n,this.router=o}var I=(S.forRoot=function(){return{ngModule:S,providers:[f]}},S.decorators=[{type:t.NgModule,args:[{declarations:[w,U],imports:[a.CommonModule,l.FormsModule,s.InputsModule,c.ButtonsModule],exports:[w,U]}]}],S);function S(){}n.TbAuthService=f,n.TbAuthGuard=b,n.TbAuthInterceptor=x,n.TbLoginComponent=w,n.TbLogoutComponent=U,n.TbAuthModule=I,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=tb-auth.umd.min.js.map